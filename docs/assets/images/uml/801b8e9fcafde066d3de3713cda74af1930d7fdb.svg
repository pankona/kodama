<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1427px" preserveAspectRatio="none" style="width:1122px;height:1427px;" version="1.1" viewBox="0 0 1122 1427" width="1122px" zoomAndPan="magnify"><defs><filter height="300%" id="f177no24ag7lf2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1405" style="stroke: #383838; stroke-width: 1.0;" width="503" x="439" y="4"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="610.5" y="19.8379">Async Job System</text><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="52" x2="52" y1="63" y2="1415"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="145" x2="145" y1="63" y2="1415"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="502" x2="502" y1="63" y2="1415"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="733" x2="733" y1="63" y2="1415"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="919" x2="919" y1="63" y2="1415"/><rect fill="#F8F8F8" filter="url(#f177no24ag7lf2)" height="32" style="stroke: #383838; stroke-width: 1.5;" width="84" x="8" y="26"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="70" x="15" y="48.8379">Web App</text><rect fill="#F8F8F8" filter="url(#f177no24ag7lf2)" height="32" style="stroke: #383838; stroke-width: 1.5;" width="74" x="106" y="26"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="113" y="48.8379">Worker</text><rect fill="#F8F8F8" filter="url(#f177no24ag7lf2)" height="32" style="stroke: #383838; stroke-width: 1.5;" width="114" x="443" y="26"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="450" y="48.8379">API Server</text><rect fill="#F8F8F8" filter="url(#f177no24ag7lf2)" height="32" style="stroke: #383838; stroke-width: 1.5;" width="104" x="679" y="26"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="686" y="48.8379">Job Queue</text><rect fill="#F8F8F8" filter="url(#f177no24ag7lf2)" height="32" style="stroke: #383838; stroke-width: 1.5;" width="34" x="900" y="26"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="907" y="48.8379">DB</text><rect fill="#EEEEEE" filter="url(#f177no24ag7lf2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1107" x="3" y="95"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1110" y1="95" y2="95"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1110" y1="98" y2="98"/><rect fill="#EEEEEE" filter="url(#f177no24ag7lf2)" height="26" style="stroke: #000000; stroke-width: 2.0;" width="138" x="487.5" y="83"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="493.5" y="102.8379">ジョブの登録</text><polygon fill="#383838" points="490,139,500,143,490,147,494,143" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="52" x2="496" y1="143" y2="143"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="59" y="138.8379">ジョブ登録</text><polygon fill="#383838" points="721,171,731,175,721,179,725,175" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="502" x2="727" y1="175" y2="175"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="509" y="170.8379">ジョブ登録</text><line style="stroke: #383838; stroke-width: 1.0;" x1="733" x2="775" y1="207" y2="207"/><line style="stroke: #383838; stroke-width: 1.0;" x1="775" x2="775" y1="207" y2="220"/><line style="stroke: #383838; stroke-width: 1.0;" x1="734" x2="775" y1="220" y2="220"/><polygon fill="#383838" points="744,216,734,220,744,224,740,220" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="740" y="202.8379">ジョブ ID 生成</text><polygon fill="#383838" points="907,266,917,270,907,274,911,270" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="733" x2="913" y1="270" y2="270"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="740" y="247.8379">ジョブ挿入</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="99" x="740" y="265.8379">(ジョブ ID)</text><polygon fill="#383838" points="744,298,734,302,744,306,740,302" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="738" x2="918" y1="302" y2="302"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="18" x="750" y="297.8379">OK</text><polygon fill="#383838" points="513,330,503,334,513,338,509,334" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="507" x2="732" y1="334" y2="334"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="81" x="519" y="329.8379">ジョブ ID</text><polygon fill="#383838" points="63,362,53,366,63,370,59,366" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57" x2="501" y1="366" y2="366"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="81" x="69" y="361.8379">ジョブ ID</text><rect fill="#EEEEEE" filter="url(#f177no24ag7lf2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1107" x="3" y="396"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1110" y1="396" y2="396"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1110" y1="399" y2="399"/><rect fill="#EEEEEE" filter="url(#f177no24ag7lf2)" height="26" style="stroke: #000000; stroke-width: 2.0;" width="138" x="487.5" y="384"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="493.5" y="403.8379">ジョブの実行</text><polygon fill="#383838" points="490,440,500,444,490,448,494,444" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="145" x2="496" y1="444" y2="444"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="152" y="439.8379">ジョブ取り出し</text><polygon fill="#383838" points="721,472,731,476,721,480,725,476" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="502" x2="727" y1="476" y2="476"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="509" y="471.8379">ジョブ取り出し</text><polygon fill="#383838" points="907,522,917,526,907,530,911,526" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="733" x2="913" y1="526" y2="526"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="72" x="740" y="503.8379">実行待ち</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="740" y="521.8379">ジョブ取り出し</text><path d="M738,539 L738,567 L1065,567 L1065,549 L1055,539 L738,539 " fill="#ECECEC" filter="url(#f177no24ag7lf2)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M1055,539 L1055,549 L1065,549 L1055,539 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="306" x="744" y="559.8379">ジョブの状態を「実行中」に変更する</text><polygon fill="#383838" points="744,596,734,600,744,604,740,600" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="738" x2="918" y1="600" y2="600"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="750" y="595.8379">ジョブ詳細</text><polygon fill="#383838" points="513,628,503,632,513,636,509,632" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="507" x2="732" y1="632" y2="632"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="519" y="627.8379">ジョブ詳細</text><polygon fill="#383838" points="156,660,146,664,156,668,152,664" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="150" x2="501" y1="664" y2="664"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="162" y="659.8379">ジョブ詳細</text><line style="stroke: #383838; stroke-width: 1.0;" x1="145" x2="187" y1="696" y2="696"/><line style="stroke: #383838; stroke-width: 1.0;" x1="187" x2="187" y1="696" y2="709"/><line style="stroke: #383838; stroke-width: 1.0;" x1="146" x2="187" y1="709" y2="709"/><polygon fill="#383838" points="156,705,146,709,156,713,152,709" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="152" y="691.8379">ジョブ実行</text><path d="M150,722 L150,750 L297,750 L297,732 L287,722 L150,722 " fill="#ECECEC" filter="url(#f177no24ag7lf2)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M287,722 L287,732 L297,732 L287,722 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="156" y="742.8379">時間かかるかも</text><polygon fill="#383838" points="490,779,500,783,490,787,494,783" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="145" x2="496" y1="783" y2="783"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="333" x="152" y="778.8379">ジョブ状態更新 (ジョブ ID、成功/失敗)</text><polygon fill="#383838" points="721,811,731,815,721,819,725,815" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="502" x2="727" y1="815" y2="815"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="509" y="810.8379">ジョブ状態更新</text><path d="M738,828 L738,910 L1083,910 L1083,838 L1073,828 L738,828 " fill="#ECECEC" filter="url(#f177no24ag7lf2)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M1073,828 L1073,838 L1083,838 L1073,828 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="324" x="744" y="848.8379">ジョブ実行が失敗、かつリトライ回数が</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="315" x="744" y="866.8379">規定 (5回) に満たない場合、ジョブの</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="234" x="744" y="884.8379">状態を「実行待ち」に変更、</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="252" x="744" y="902.8379">リトライ試行済回数を加算する</text><path d="M738,924 L738,1006 L1101,1006 L1101,934 L1091,924 L738,924 " fill="#ECECEC" filter="url(#f177no24ag7lf2)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M1091,924 L1091,934 L1101,934 L1091,924 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="324" x="744" y="944.8379">ジョブ実行が失敗、かつリトライ回数が</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="297" x="744" y="962.8379">規定 (5回) を超えた場合、ジョブの</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="342" x="744" y="980.8379">状態を「失敗」に変更し、システム管理者</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="54" x="744" y="998.8379">に通知</text><path d="M738,1020 L738,1066 L1065,1066 L1065,1030 L1055,1020 L738,1020 " fill="#ECECEC" filter="url(#f177no24ag7lf2)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M1055,1020 L1055,1030 L1065,1030 L1055,1020 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="306" x="744" y="1040.8379">ジョブ実行が成功した場合、ジョブの</text><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="216" x="744" y="1058.8379">状態を「成功」に変更する</text><polygon fill="#383838" points="907,1095,917,1099,907,1103,911,1099" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="733" x2="913" y1="1099" y2="1099"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="126" x="740" y="1094.8379">ジョブ状態更新</text><polygon fill="#383838" points="744,1127,734,1131,744,1135,740,1131" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="738" x2="918" y1="1131" y2="1131"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="18" x="750" y="1126.8379">OK</text><polygon fill="#383838" points="513,1141,503,1145,513,1149,509,1145" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="507" x2="732" y1="1145" y2="1145"/><polygon fill="#383838" points="156,1155,146,1159,156,1163,152,1159" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="150" x2="501" y1="1159" y2="1159"/><rect fill="#EEEEEE" filter="url(#f177no24ag7lf2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1107" x="3" y="1189"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1110" y1="1189" y2="1189"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1110" y1="1192" y2="1192"/><rect fill="#EEEEEE" filter="url(#f177no24ag7lf2)" height="26" style="stroke: #000000; stroke-width: 2.0;" width="176" x="468.5" y="1177"/><text fill="#000000" font-family="courier" font-size="18" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="474.5" y="1196.8379">ジョブの状態確認</text><polygon fill="#383838" points="490,1233,500,1237,490,1241,494,1237" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="52" x2="496" y1="1237" y2="1237"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="234" x="59" y="1232.8379">ジョブ状態取得 (ジョブ ID)</text><polygon fill="#383838" points="721,1265,731,1269,721,1273,725,1269" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="502" x2="727" y1="1269" y2="1269"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="207" x="509" y="1264.8379">ジョブ状態取得 (Job ID)</text><polygon fill="#383838" points="907,1297,917,1301,907,1305,911,1301" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="733" x2="913" y1="1301" y2="1301"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="162" x="740" y="1296.8379">指定のジョブを取得</text><polygon fill="#383838" points="744,1329,734,1333,744,1337,740,1333" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="738" x2="918" y1="1333" y2="1333"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="750" y="1328.8379">ジョブ詳細</text><polygon fill="#383838" points="513,1361,503,1365,513,1369,509,1365" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="507" x2="732" y1="1365" y2="1365"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="519" y="1360.8379">ジョブ詳細</text><polygon fill="#383838" points="63,1393,53,1397,63,1401,59,1397" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57" x2="501" y1="1397" y2="1397"/><text fill="#000000" font-family="courier" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="90" x="69" y="1392.8379">ジョブ詳細</text><!--
@startuml

skinparam monochrome true
skinparam defaultFontSize 18
skinparam defaultFontName courier

hide footbox

participant "**Web App**"    as app
participant "**Worker**"     as worker
box "Async Job System"
participant "**API Server**" as api
participant "**Job Queue**"  as queue
participant "**DB**"         as db
end box

== ジョブの登録 ==

app -> api : ジョブ登録
    api -> queue :  ジョブ登録
        queue -> queue : ジョブ ID 生成
        queue -> db : ジョブ挿入\n(ジョブ ID)
        queue <- - db : OK
   api <- - queue : ジョブ ID
app <- - api : ジョブ ID

== ジョブの実行 ==

api <- worker : ジョブ取り出し
    api -> queue : ジョブ取り出し
        queue -> db : 実行待ち\nジョブ取り出し
        note right of queue: ジョブの状態を「実行中」に変更する
        queue <- - db : ジョブ詳細
    api <- - queue : ジョブ詳細
api - -> worker : ジョブ詳細

worker -> worker : ジョブ実行
note right of worker : 時間かかるかも

api <- worker : ジョブ状態更新 (ジョブ ID、成功/失敗)
    api -> queue : ジョブ状態更新
        note right of queue: ジョブ実行が失敗、かつリトライ回数が\n規定 (5回) に満たない場合、ジョブの\n状態を「実行待ち」に変更、\nリトライ試行済回数を加算する
        note right of queue: ジョブ実行が失敗、かつリトライ回数が\n規定 (5回) を超えた場合、ジョブの\n状態を「失敗」に変更し、システム管理者\nに通知
        note right of queue: ジョブ実行が成功した場合、ジョブの\n状態を「成功」に変更する
        queue -> db : ジョブ状態更新
        queue <- - db : OK
    api <- - queue
api - -> worker

== ジョブの状態確認 ==

app -> api : ジョブ状態取得 (ジョブ ID)
    api -> queue : ジョブ状態取得 (Job ID)
        queue -> db : 指定のジョブを取得
        queue <- - db : ジョブ詳細
    api <- - queue : ジョブ詳細
app <- - api : ジョブ詳細

@enduml

PlantUML version 1.2018.02(Sat Mar 10 02:20:44 JST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_192-b26
Operating System: Linux
OS Version: 4.12.14-1-MANJARO
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>